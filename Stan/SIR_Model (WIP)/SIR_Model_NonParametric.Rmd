---
title: "Modeling"
author: "Brynjólfur Gauti Jónsson"
date: "3/15/2020"
output: 
    html_document:
        theme: flaty
        code_folding: hide
        toc: true
        toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, 
                      fig.width = 8, fig.asp = 0.621, out.width = "100%")
```

```{r}
library(tidyverse); library(knitr); library(kableExtra); library(broom); library(cowplot); 
library(rstan); library(tidybayes); library(scales)
library(lubridate); library(ggtext); library(shinystan)
theme_set(theme_bw(base_size = 18) + 
              panel_border(colour = "grey30", size = 1) + 
              background_grid(color.major = "grey90", 
                              color.minor = "grey95", 
                              minor = "xy", major = "xy"))
options(mc.cores = parallel::detectCores())


d <- read_csv("https://docs.google.com/spreadsheets/d/1xgDhtejTtcyy6EN5dbDp5W3TeJhKFRRgm6Xk0s0YFeA/export?format=csv&id=1xgDhtejTtcyy6EN5dbDp5W3TeJhKFRRgm6Xk0s0YFeA&gid=1788393542") %>% 
    select(
        date = "Dagsetning",
        new_cases = "Ny_Smit",
        new_deaths = "Dauðsföll",
        new_recovered = "Batnað", 
        total_cases = "Smit_Samtals",
        total_deaths = "Dauðsföll_Samtals",
        total_recovered = "Batnað_Samtals",
        total_removed = "Removed_Samtals",
        active_cases = "Virk_Smit")

d <- d %>% 
    mutate(date = ymd(date),
           N = 364220,
           S = N - total_cases,
           S = lag(S, 1, default = 0),
           active_cases = lag(active_cases, 1, default = 0)) %>% 
    select(date, dI_dt = new_cases, total_cases, S,  I = active_cases, R = total_removed, N) %>% 
    filter(date >= ymd("2020-03-03"))

d
```

Let $D$ be the days since the government introduced actions. Then we can model

$$
\log(\beta) = \beta_0 + \alpha (1 - e^{-\rho D}) + \varepsilon_\beta
$$

```{r}
N_days <- nrow(d)

S <- d$S
I <- d$I
dI_dt <- d$dI_dt
N <- 364220


days <- seq_len(N_days) - 1

stan_data <- list(
    N_days = N_days,
    N = N,
    S  = S,
    I = I,
    dI_dt = dI_dt,
    days = days
)

str(stan_data)
```


```{r}
m <- sampling(stan_model("SIR_Model_Discrete_NonParametric.stan"), 
              data  = stan_data, chains = 4, iter = 2000, warmup = 1000,
              control = list(adapt_delta = 0.99))
```

```{r}
tidyMCMC(m, conf.int = T, rhat = T, ess = T) %>% 
    arrange(desc(rhat))
```


```{r}
tidyMCMC(m, pars = c("rho", "alpha", "phi_inv_sqrt", "log_beta_intercept", "r0", "r[45]"), 
         conf.int = T, rhat = T, ess = T)
```

```{r}

```


```{r}
spread_draws(m, r0) %>% 
    ggplot(aes(r0)) +
    geom_histogram()
```

```{r}
curve(dgamma(x, 20, 2.5), from = 0, to = 30)
```


```{r}
tidyMCMC(m, pars = "r", conf.int = T, rhat = T, ess = T) %>% 
    mutate(date = min(d$date) + row_number() - 1) %>% 
    ggplot(aes(date, estimate, ymin = conf.low, ymax = conf.high)) +
    geom_ribbon(alpha = 0.3) +
    geom_line() +
    geom_hline(yintercept = 1, lty = 2, col = "grey60") +
    # Fyrra samkomubann
    geom_vline(xintercept = ymd("2020-03-16"), lty = 2) +
    geom_text(data = tibble(), 
              aes(x = ymd("2020-03-16"), y = 0.2, label = "Fyrri samkomubann"), 
              inherit.aes = F, nudge_x = 2.4) +
    # Seinna samkomubann
    geom_vline(xintercept = ymd("2020-03-24"), lty = 2) +
    geom_text(data = tibble(), 
              aes(x = ymd("2020-03-24"), y = 3.5, label = "Seinni samkomubann"), 
              inherit.aes = F, nudge_x = 2.4) +
    scale_y_continuous(breaks = pretty_breaks(8)) +
    scale_x_date(breaks = ymd(c("2020-03-05", "2020-03-16", "2020-03-24", "2020-04-01")),
                 date_labels = "%d. %B") +
    ylab(latex2exp::TeX("$R_t$")) + 
    ggtitle(latex2exp::TeX("Þróun $R_t$ á Íslandi")) +
    theme(axis.title.x = element_blank()) +
    background_grid(major = "none", minor = "none") +
    ggsave("r0_islandi.png", width = 6, height = 0.5 * 6, scale = 2)
```


```{r}
tidyMCMC(m, pars = "r", conf.int = T, rhat = T, ess = T) %>% 
    mutate(date = min(d$date) + row_number() - 1) %>% 
    ggplot(aes(date, estimate, ymin = conf.low, ymax = conf.high)) +
    geom_ribbon(alpha = 0.3) +
    geom_line() +
    geom_hline(yintercept = 1, lty = 2, col = "grey60") +
    # Fyrra samkomubann
    geom_vline(xintercept = ymd("2020-03-16"), lty = 2) +
    # Seinna samkomubann
    geom_vline(xintercept = ymd("2020-03-24"), lty = 2) +
    scale_y_continuous(breaks = c(0, 1, 2, 3, 4, 5, 6), expand = expansion()) +
    scale_x_date(breaks = ymd(c("2020-03-03", 
                                "2020-03-17", "2020-03-24",
                                "2020-04-01", 
                                "2020-04-15")),
                 labels = c(quote("March 3^rd"), 
                            quote("March 16^th"), quote("March 24^th"),
                            quote("April 1^st"), 
                            quote("April 15^th"))) +
    labs(y = "R") +
    theme(axis.title = element_blank(), axis.text.x = element_markdown()) +
    coord_cartesian(ylim = c(0, 7)) +
    background_grid(major = "none", minor = "none") +
    ggsave("r0_iceland.png", width = 6, height = 0.5 * 6, scale = 2)
```

```{r}
spread_draws(m, r[day]) %>% 
    ungroup %>% 
    mutate(date = min(d$date) + day - 1) %>% 
    select(date, r) %>% 
    group_by(date) %>% 
    mutate(iter = row_number()) %>% 
    ungroup %>% 
    filter(iter >= max(iter) - 1000) %>% 
    ggplot(aes(date, r, group = iter)) +
    geom_line(alpha = 0.05) +
    geom_smooth(aes(group = "none")) +
    geom_hline(yintercept = 1, lty = 2, size = 1.5, col = "grey") +
    coord_cartesian(ylim = c(0, 7))
```


```{r}
tidyMCMC(m, pars = "f", conf.int = T, rhat = T, ess = T) %>% 
    mutate(date = min(d$date) + row_number() - 1) %>% 
    ggplot(aes(date, estimate, ymin = conf.low, ymax = conf.high)) +
    geom_ribbon(alpha = 0.3) +
    geom_line() +
    geom_hline(yintercept = 1, lty = 2, col = "grey60") +
    # Fyrra samkomubann
    geom_vline(xintercept = ymd("2020-03-16"), lty = 2) +
    # Seinna samkomubann
    geom_vline(xintercept = ymd("2020-03-24"), lty = 2) +
    scale_y_continuous(breaks = pretty_breaks(8)) +
    scale_x_date(breaks = ymd(c("2020-03-03", "2020-03-16", "2020-03-24", "2020-04-01", "2020-04-08")),
                 date_labels = "%d. %B") +
    labs(y = "f") + 
    theme(axis.title.x = element_blank()) +
    background_grid(major = "none", minor = "none")
```