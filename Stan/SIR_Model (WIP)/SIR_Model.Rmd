---
title: "Modeling"
author: "Brynjólfur Gauti Jónsson"
date: "3/15/2020"
output: 
    html_document:
        theme: flaty
        code_folding: hide
        toc: true
        toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, 
                      fig.width = 8, fig.asp = 0.621, out.width = "100%")
```

```{r}
library(tidyverse); library(knitr); library(kableExtra); library(broom); library(cowplot); 
library(rstan); library(tidybayes); library(scales)
library(lubridate); library(ggtext)
theme_set(theme_bw() + 
              panel_border(colour = "grey30", size = 1) + 
              background_grid(color.major = "grey90", 
                              color.minor = "grey95", 
                              minor = "xy", major = "xy"))



d <- read_csv("https://docs.google.com/spreadsheets/d/1ODqwILD6yBfE5mgKmI4mE-t-wzBDaw8l27gERUiAMgo/export?format=csv&gid=0") %>% 
    select(
        date = "Dagsetning",
        new_cases = "Ny_Smit",
        new_deaths = "Dauðsföll",
        new_recovered = "Batnað", 
        total_cases = "Smit_Samtals",
        total_deaths = "Dauðsföll_Samtals",
        total_recovered = "Batnað_Samtals",
        total_removed = "Removed_Samtals",
        active_cases = "Virk_Smit")

d <- d %>% 
    mutate(date = mdy(date),
           new_cases = lead(new_cases, 1, default = 0),
           N = 364220,
           S = N - total_cases) %>% 
    select(date, dI_dt = new_cases, total_cases, S,  I = active_cases, R = total_removed, N) %>% 
    filter(date >= ymd("2020-03-09"))

d
```


```{r}
N_days <- nrow(d)

S <- d$S
I <- d$I
dI_dt <- d$dI_dt
N <- 364220

eftir_bann <- cumsum(1 * (d$date > ymd("2020-03-17")))

days <- seq_len(N_days) - 1

stan_data <- list(
    N_days = N_days,
    N = N,
    S  = S,
    I = I,
    dI_dt = dI_dt,
    days = days,
    eftir_bann = eftir_bann
)

str(stan_data)
```


```{r}
m <- sampling(stan_model("SIR_Model_Discrete.stan"), 
              data  = stan_data, chains = 4, iter = 2000, warmup = 1000)
```

```{r}
d %>% 
    mutate(beta = dI_dt * N / (I * S))
```


```{r}
tidyMCMC(m, pars = "beta", conf.int = T, rhat = T, ess = T) %>% 
    mutate(date = min(d$date) + row_number() - 1) %>% 
    ggplot(aes(date, estimate, ymin = conf.low, ymax = conf.high)) +
    geom_ribbon(alpha = 0.3) +
    geom_line() +
    geom_point(data = d %>% mutate(beta = dI_dt * N / (S * I)), aes(x = date, y = beta), inherit.aes = F) +
    geom_vline(xintercept = ymd("2020-03-16"), lty = 2)
```


```{r}
tidyMCMC(m, pars = "r0", conf.int = T, rhat = T, ess = T) %>% 
    mutate(date = min(d$date) + row_number() - 1) %>% 
    ggplot(aes(date, estimate, ymin = conf.low, ymax = conf.high)) +
    geom_ribbon(alpha = 0.3) +
    geom_line() +
    geom_hline(yintercept = 1, lty = 2, col = "grey60") +
    # Fyrra samkomubann
    geom_vline(xintercept = ymd("2020-03-16"), lty = 2) +
    geom_text(data = tibble(), 
              aes(x = ymd("2020-03-16"), y = 0.2, label = "Fyrra samkomubann"), 
              inherit.aes = F, nudge_x = 2.7) +
    # Seinna samkomubann
    geom_vline(xintercept = ymd("2020-03-24"), lty = 2) +
    geom_text(data = tibble(), 
              aes(x = ymd("2020-03-24"), y = 3.5, label = "Seinna samkomubann"), 
              inherit.aes = F, nudge_x = 2.8) +
    scale_y_continuous(breaks = pretty_breaks(8)) +
    ylab(latex2exp::TeX("$R_e$")) + 
    ggtitle(latex2exp::TeX("Þróun $R_e$ á Íslandi")) +
    theme(axis.title.x = element_blank()) +
    background_grid(major = "none", minor = "none") +
    ggsave("r0_islandi.png", width = 6, height = 0.621 * 6, scale = 1.5)
```

